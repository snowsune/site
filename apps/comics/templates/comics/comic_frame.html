{% load static %}

<div class="comic-frame size-{{ size|default:'medium' }}" data-current-page="{{ current_page.page_number|default:1 }}">
    <div class="comic-navigation-controls">
        <div class="nav-left">
            <div class="nav-btn-group">
                <!-- First Page Button -->
                {% if current_page and current_page.page_number > 1 %}
                <a href="{% url 'comics:page_detail' 1 %}" class="nav-btn nav-btn-small" title="First Page">
                    <img src="{% static 'nav/activated.png' %}" alt="First"
                        class="nav-icon nav-icon-activated nav-icon-rotated">
                    <img src="{% static 'nav/deactivated.png' %}" alt="First"
                        class="nav-icon nav-icon-deactivated nav-icon-rotated">
                    <span class="nav-label">First</span>
                </a>
                {% else %}
                <span class="nav-btn nav-btn-small disabled" title="First Page">
                    <img src="{% static 'nav/deactivated.png' %}" alt="First"
                        class="nav-icon nav-icon-deactivated nav-icon-rotated">
                    <span class="nav-label">First</span>
                </span>
                {% endif %}

                {% if current_page and current_page.has_previous %}
                <a href="{% url 'comics:page_detail' current_page.get_previous_page.page_number %}" class="nav-btn"
                    title="Previous Page">
                    <img src="{% static 'nav/activated.png' %}" alt="Previous" class="nav-icon nav-icon-activated">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Previous" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Previous</span>
                </a>
                {% else %}
                <span class="nav-btn disabled" title="Previous Page">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Previous" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Previous</span>
                </span>
                {% endif %}
            </div>
        </div>

        <div class="nav-center">
            <div class="page-selector">
                <select id="page-selector" onchange="goToPage(this.value)">
                    {% for page in available_pages %}
                    <option value="{{ page.page_number }}"
                        {% if current_page and current_page.page_number == page.page_number %}selected{% endif %}>
                        Page {{ page.page_number }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            {% if current_page %}
            <div class="page-info">
                {% if current_page.title %}
                <span class="page-title">{{ current_page.title }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="nav-right">
            <div class="nav-btn-group">
                {% if current_page and current_page.has_next %}
                <a href="{% url 'comics:page_detail' current_page.get_next_page.page_number %}" class="nav-btn"
                    title="Next Page">
                    <img src="{% static 'nav/activated.png' %}" alt="Next" class="nav-icon nav-icon-activated">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Next" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Next</span>
                </a>
                {% else %}
                <span class="nav-btn disabled" title="Next Page">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Next" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Next</span>
                </span>
                {% endif %}

                <!-- Latest Page Button -->
                {% if current_page and current_page.page_number < available_pages|length %}
                <a href="{% url 'comics:page_detail' available_pages|length %}" class="nav-btn nav-btn-small"
                    title="Latest Page">
                    <img src="{% static 'nav/activated.png' %}" alt="Latest" class="nav-icon nav-icon-activated">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Latest" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Latest</span>
                </a>
                {% else %}
                <span class="nav-btn nav-btn-small disabled" title="Latest Page">
                    <img src="{% static 'nav/deactivated.png' %}" alt="Latest" class="nav-icon nav-icon-deactivated">
                    <span class="nav-label">Latest</span>
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="comic-display">
        {% if current_page %}
        <div class="comic-image-container">
            {% if current_page.is_nsfw %}
            <div class="nsfw-blur-overlay" id="nsfw-blur-{{ current_page.page_number }}">
                <div class="nsfw-warning-content">
                    <h3>⚠️ Watch out!</h3>
                    <p>Sometimes my comic contains adult content!</p>
                    <button class="nsfw-acknowledge-btn" onclick="acknowledgeNSFW({{ current_page.page_number }})">
                        Show me this lewd page anyway!
                    </button>
                    <p>...or if that's not your thing, click to the next comic!</p>
                </div>
            </div>
            {% endif %}
            <img src="{{ current_page.image.url }}" alt="{{ current_page.title }}"
                class="comic-image {% if current_page.is_nsfw %}nsfw-blurred{% endif %}"
                id="comic-image-{{ current_page.page_number }}">

            <!-- Transcript Overlay -->
            {% if current_page.transcript.elements %}
            <div class="transcript-overlay" id="transcript-overlay-{{ current_page.page_number }}">
                {% for element in current_page.transcript.elements %}
                <div class="transcript-element {{ element.type }} {{ element.css_class|default:'' }}"
                    data-element-type="{{ element.type }}" data-text="{{ element.text|escape }}"
                    data-character="{{ element.character_name|default:''|escape }}" data-x1="{{ element.x1 }}"
                    data-y1="{{ element.y1 }}" data-x2="{{ element.x2 }}" data-y2="{{ element.y2 }}">
                    {% if element.type == 'note' %}
                    <div class="note-content">{{ element.text }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% if show_description and current_page.description %}
        <div class="comic-description markdown-content">
            {{ current_page.description_html|safe }}
        </div>
        {% endif %}
        {% else %}
        <div class="comic-placeholder">
            <p>No comic page selected</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function goToPage(pageNumber) {
        if (pageNumber) {
            window.location.href = `/comics/page/${pageNumber}/`;
        }
    }

    function acknowledgeNSFW(pageNumber) {
        const blurOverlay = document.getElementById(`nsfw-blur-${pageNumber}`);
        const comicImage = document.getElementById(`comic-image-${pageNumber}`);

        if (blurOverlay && comicImage) {
            blurOverlay.style.display = 'none';
            comicImage.classList.remove('nsfw-blurred');

            // Store acknowledgment in sessionStorage
            sessionStorage.setItem(`nsfw-acknowledged-${pageNumber}`, 'true');
        }
    }

    // Check for existing NSFW acknowledgments on page load
    document.addEventListener('DOMContentLoaded', function () {
        const comicFrame = document.querySelector('.comic-frame');
        if (!comicFrame) return;

        const currentPage = comicFrame.dataset.currentPage;
        if (currentPage && sessionStorage.getItem(`nsfw-acknowledged-${currentPage}`) === 'true') {
            const blurOverlay = document.getElementById(`nsfw-blur-${currentPage}`);
            const comicImage = document.getElementById(`comic-image-${currentPage}`);

            if (blurOverlay && comicImage) {
                blurOverlay.style.display = 'none';
                comicImage.classList.remove('nsfw-blurred');
            }
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        const comicFrame = document.querySelector('.comic-frame');
        if (!comicFrame) return;

        const currentPage = parseInt(comicFrame.dataset.currentPage);

        switch (e.key) {
            case 'ArrowLeft':
                const prevBtn = comicFrame.querySelector('.nav-left .nav-btn:not(.disabled)');
                if (prevBtn && prevBtn.href) {
                    e.preventDefault();
                    window.location.href = prevBtn.href;
                }
                break;
            case 'ArrowRight':
                const nextBtn = comicFrame.querySelector('.nav-right .nav-btn:not(.disabled)');
                if (nextBtn && nextBtn.href) {
                    e.preventDefault();
                    window.location.href = nextBtn.href;
                }
                break;
        }
    });

    // Transcript Element Functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Position transcript elements based on displayed image size
        positionTranscriptElements();

        // Add hover tooltips for transcript elements
        const transcriptElements = document.querySelectorAll('.transcript-element');

        transcriptElements.forEach(element => {
            const elementType = element.dataset.elementType;
            const text = element.dataset.text;
            const character = element.dataset.character;

            if (elementType === 'transcript') {
                // Add title attribute for hover tooltip
                element.title = text;
            }

            if (elementType === 'credits') {
                // Make credits clickable - open text content as link in new tab
                element.addEventListener('click', function () {
                    // Check if the text looks like a URL
                    if (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('www.')) {
                        // If it's a URL, open it directly
                        window.open(text, '_blank');
                    } else {
                        // If it's not a URL, try to make it one by adding https://
                        const url = text.includes('://') ? text : `https://${text}`;
                        window.open(url, '_blank');
                    }
                });
            }
        });
    });

    // Handle window resize for transcript elements
    window.addEventListener('resize', function () {
        setTimeout(positionTranscriptElements, 100); // Small delay to ensure resize is complete
    });

    function positionTranscriptElements() {
        const comicFrame = document.querySelector('.comic-frame');
        if (!comicFrame) return;

        const currentPage = comicFrame.dataset.currentPage;
        const image = document.getElementById(`comic-image-${currentPage}`);
        const overlay = document.getElementById(`transcript-overlay-${currentPage}`);

        if (!image || !overlay) return;

        // Wait for image to be fully loaded
        if (image.complete) {
            calculateElementPositions(image, overlay);
        } else {
            image.onload = function () {
                calculateElementPositions(image, overlay);
            };
        }
    }

    function calculateElementPositions(image, overlay) {
        const imageRect = image.getBoundingClientRect();
        const containerRect = image.parentElement.getBoundingClientRect();

        // Calculate scaling factors
        const scaleX = imageRect.width / image.naturalWidth;
        const scaleY = imageRect.height / image.naturalHeight;

        // Position overlay to align with the image
        const imageOffsetX = imageRect.left - containerRect.left;
        const imageOffsetY = imageRect.top - containerRect.top;

        overlay.style.left = imageOffsetX + 'px';
        overlay.style.top = imageOffsetY + 'px';
        overlay.style.width = imageRect.width + 'px';
        overlay.style.height = imageRect.height + 'px';

        // Position and size each transcript element
        const elements = overlay.querySelectorAll('.transcript-element');
        elements.forEach(element => {
            const x1 = parseInt(element.dataset.x1);
            const y1 = parseInt(element.dataset.y1);
            const x2 = parseInt(element.dataset.x2);
            const y2 = parseInt(element.dataset.y2);

            // Scale coordinates to match displayed image
            const scaledX1 = x1 * scaleX;
            const scaledY1 = y1 * scaleY;
            const scaledWidth = (x2 - x1) * scaleX;
            const scaledHeight = (y2 - y1) * scaleY;

            // Apply scaled positioning and sizing
            element.style.left = scaledX1 + 'px';
            element.style.top = scaledY1 + 'px';
            element.style.width = scaledWidth + 'px';
            element.style.height = scaledHeight + 'px';
        });
    }
</script>