{% extends 'base.html' %}
{% load static %}
{% load image_tags %}

{% block title %}{{ post.title }} - Snowsune Blog{% endblock %}

{% block meta_keywords %}{{ post.tags.all|join:", " }}, blog, furry, art, community, snowsune, vixi{% endblock %}
{% block meta_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.excerpt|truncatewords:30 }}{% endif %}{% endblock %}
{% block og_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.excerpt|truncatewords:30 }}{% endif %}{% endblock %}
{% block twitter_description %}{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.excerpt|truncatewords:30 }}{% endif %}{% endblock %}
{% block og_image %}{% if post.featured_image %}{{ post.featured_image.url }}{% else %}{% static 'placeholders/placeholder_wide.png' %}{% endif %}{% endblock %}
{% block twitter_image %}{% if post.featured_image %}{{ post.featured_image.url }}{% else %}{% static 'placeholders/placeholder_wide.png' %}{% endif %}{% endblock %}
{% block og_image_alt %}{{ post.title }} - Snowsune Blog{% endblock %}
{% block twitter_image_alt %}{{ post.title }} - Snowsune Blog{% endblock %}
{% block canonical_url %}https://snowsune.net{{ post.get_absolute_url }}{% endblock %}
{% block meta_subject %}Blog Post, {{ post.tags.all|join:", " }}{% endblock %}
{% block meta_category %}Blog, Content{% endblock %}
{% block schema_description %}{{ post.title }} -
{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.excerpt|truncatewords:30 }}{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog.css' %}">
{% endblock %}

{% block extra_head %}
<!-- Structured Data for Blog Post -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.title }}",
  "description": "{% if post.meta_description %}{{ post.meta_description }}{% else %}{{ post.excerpt|truncatewords:30 }}{% endif %}",
  "author": {
    "@type": "Person",
    "name": "{{ post.author.username }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Snowsune.net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://snowsune.net{% static 'logos/logo.png' %}"
    }
  },
  "datePublished": "{{ post.published_at|date:'c' }}",
  "dateModified": "{{ post.updated_at|date:'c' }}",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://snowsune.net{{ post.get_absolute_url }}"
  },
  "image": "{% if post.featured_image %}{{ post.featured_image.url|social_preview_url_og:request }}{% else %}https://snowsune.net{% static 'placeholders/placeholder_wide.png' %}{% endif %}",
  "keywords": "{{ post.tags.all|join:', ' }}, blog, furry, art, community, snowsune, vixi",
  "articleSection": "Blog",
  "inLanguage": "en-US"
}
</script>
{% endblock %}

{% block content %}
<div class="blog-post-container">
    <article class="blog-post">
        <!-- Post Header -->
        <header class="post-header">
            <div class="post-header-content">
                {% if post.featured_image %}
                <div class="post-thumbnail">
                    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
                </div>
                {% endif %}

                <div class="post-header-text">
                    <div class="post-meta">
                        <span class="post-date">{{ post.display_date|date:"F j, Y" }}</span>
                        <span class="post-author">by {{ post.author.username }}</span>
                        {% if post.status == 'draft' %}
                        <span class="post-status draft">Draft</span>
                        {% endif %}
                    </div>

                    <h1 class="post-title">{{ post.title }}</h1>

                    {% if post.meta_description %}
                    <p class="post-description">{{ post.meta_description }}</p>
                    {% endif %}

                    {% if post.tags.all %}
                    <div class="post-tags">
                        {% for tag in post.tags.all %}
                        <a href="{% url 'blog:blog_list' %}?tag={{ tag.slug }}" class="tag">{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </header>


        <!-- Poll Voting Widget -->
        {% if post.is_poll %}
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <div class="poll-widget" id="poll-widget-{{ post.id }}">
            <h3>Vote on this Poll!</h3>

            {% if post.is_poll_expired %}
            <p class="poll-expired">Poll has expired</p>
            {% endif %}

            <div class="poll-controls">
                <button class="vote-btn" data-vote="-1" onclick="votePoll({{ post.id }}, -1)">
                    üëé Thumbs Down
                </button>
                <button class="vote-btn" data-vote="0" onclick="votePoll({{ post.id }}, 0)">
                    ‚ûñ No Vote
                </button>
                <button class="vote-btn" data-vote="1" onclick="votePoll({{ post.id }}, 1)">
                    üëç Thumbs Up
                </button>
            </div>

            <div class="poll-results">
                <div class="poll-count">
                    <span class="count-label">üëç Up:</span>
                    <span class="count-value" id="thumbs-up-count-{{ post.id }}">{{ post.thumbs_up_count }}</span>
                </div>
                <div class="poll-count">
                    <span class="count-label">üëé Down:</span>
                    <span class="count-value" id="thumbs-down-count-{{ post.id }}">{{ post.thumbs_down_count }}</span>
                </div>
                <div class="poll-count">
                    <span class="count-label">‚ûñ No Vote:</span>
                    <span class="count-value" id="no-vote-count-{{ post.id }}">{{ post.no_vote_count }}</span>
                </div>
            </div>

            {% if post.poll_expires_at %}
            <div class="poll-expiry">
                <p><strong>Expires:</strong> {{ post.poll_expires_at|date:"M j, Y \a\t g:i A" }}</p>
                <p class="time-remaining" id="time-remaining-{{ post.id }}"></p>
            </div>
            {% endif %}

            {% if user.is_authenticated %}
            <p class="user-vote" id="user-vote-{{ post.id }}"></p>
            {% else %}
            <p><a href="{% url 'login' %}">Log in to vote</a></p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Post Content -->
        <div class="post-content markdown-content">
            {{ post.content_html|safe }}
        </div>

        <!-- Post Footer -->
        <footer class="post-footer">
            <div class="post-actions">
                {% if user == post.author or user.is_staff %}
                <a href="{% url 'blog:post_edit' post.slug %}" class="btn btn-secondary">Edit Post</a>
                <a href="{% url 'blog:post_delete' post.slug %}" class="btn btn-danger"
                    onclick="return confirm('Are you sure you want to delete this post?')">Delete Post</a>
                {% endif %}

                <a href="{% url 'blog:blog_list' %}" class="btn btn-outline">Back to Blog</a>
            </div>

            <div class="post-info">
                <p><strong>Created:</strong> {{ post.created_at|date:"F j, Y \a\t g:i A" }}</p>
                {% if post.updated_at != post.created_at %}
                <p><strong>Last updated:</strong> {{ post.updated_at|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
                {% if post.published_at %}
                <p><strong>Published:</strong> {{ post.published_at|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
                {% if post.original_posting_date %}
                <p><strong>Originally posted:</strong> {{ post.original_posting_date|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
            </div>
        </footer>
    </article>

    <!-- Related Posts -->
    {% if related_posts %}
    <section class="related-posts">
        <h3>Related Posts</h3>
        <div class="related-posts-grid">
            {% for related_post in related_posts %}
            <article class="related-post-card">
                {% if related_post.featured_image %}
                <div class="related-post-image">
                    <img src="{{ related_post.featured_image.url }}" alt="{{ related_post.title }}">
                </div>
                {% endif %}

                <div class="related-post-content">
                    <h4><a href="{{ related_post.get_absolute_url }}">{{ related_post.title }}</a></h4>
                    <p class="related-post-excerpt">{{ related_post.excerpt|truncatewords:20 }}</p>
                    <small>{{ related_post.display_date|date:"M j, Y" }}</small>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Comments Section -->
    <section class="comments-section">
        <h3>Comments</h3>

        <!-- Comment Form -->
        <div class="comment-form-container">
            <h4>Leave a Comment</h4>

            <!-- Comment Status Indicator -->
            <div class="comment-form-status {% if user.is_authenticated %}success{% else %}info{% endif %}">
                {% if user.is_authenticated %}
                üöÄ <strong>Instant Posting:</strong> Your comment will appear immediately after submission.
                {% else %}
                ‚è≥ <strong>Moderation Required:</strong> Your comment will be reviewed by site staff before appearing.
                {% endif %}
            </div>

            <form method="post" action="{% url 'blog:submit_comment' post.id %}" class="comment-form" data-comment-form>
                {% csrf_token %}

                <!-- Fallback for when JavaScript is disabled -->
                <noscript>
                    <div class="alert alert-warning">
                        <strong>JavaScript Required:</strong> This form requires JavaScript for the best experience.
                        It will still work without JavaScript, but you may experience page reloads.
                    </div>
                </noscript>

                {% if not user.is_authenticated %}
                <div class="form-group">
                    <label for="{{ comment_form.author_name.id_for_label }}">Name *</label>
                    {{ comment_form.author_name }}
                    {% if comment_form.author_name.errors %}
                    <div class="error-message">{{ comment_form.author_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ comment_form.author_email.id_for_label }}">Email</label>
                    {{ comment_form.author_email }}
                    {% if comment_form.author_email.errors %}
                    <div class="error-message">{{ comment_form.author_email.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ comment_form.author_website.id_for_label }}">Website</label>
                    {{ comment_form.author_website }}
                    {% if comment_form.author_website.errors %}
                    <div class="error-message">{{ comment_form.author_website.errors.0 }}</div>
                    {% endif %}
                </div>
                {% else %}
                <!-- Hidden fields for logged-in users -->
                {{ comment_form.author_name }}
                {{ comment_form.author_email }}
                {{ comment_form.author_website }}
                <div class="form-group">
                    <label>Commenting as: <strong>{{ user.username }}</strong></label>
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="{{ comment_form.content.id_for_label }}">Comment *</label>
                    {{ comment_form.content }}
                    {% if comment_form.content.errors %}
                    <div class="error-message">{{ comment_form.content.errors.0 }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary">Submit Comment</button>
            </form>
        </div>

        <!-- Display Comments -->
        {% if comments %}
        <div class="comments-list" data-comments-container>
            {% for comment in comments %}
            <article class="comment" id="comment-{{ comment.id }}" data-comment-id="{{ comment.id }}">
                <header class="comment-header">
                    <span class="comment-author">{{ comment.get_display_name }}</span>
                    <time class="comment-date" datetime="{{ comment.created_at|date:'c' }}">
                        {{ comment.created_at|date:"M j, Y \a\t g:i A" }}
                    </time>
                </header>

                <div class="comment-content">
                    {{ comment.content|linebreaks }}
                </div>

                <footer class="comment-actions">
                    <button class="btn btn-sm btn-outline reply-btn" data-comment-id="{{ comment.id }}"
                        data-action="reply">
                        Reply
                    </button>

                    <!-- Moderation Actions (for staff/author) -->
                    {% if user.is_staff or user == post.author %}
                    <div class="moderation-actions">
                        <a href="{% url 'blog:moderate_comment' comment.id 'approve' %}" class="btn btn-sm btn-success"
                            data-action="approve">Approve</a>
                        <a href="{% url 'blog:moderate_comment' comment.id 'reject' %}" class="btn btn-sm btn-warning"
                            data-action="reject">Reject</a>
                        <a href="{% url 'blog:moderate_comment' comment.id 'spam' %}" class="btn btn-sm btn-danger"
                            data-action="spam">Spam</a>
                    </div>
                    {% endif %}
                </footer>

                <!-- Reply Form (hidden by default) -->
                <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;" data-reply-form>
                    <form method="post" action="{% url 'blog:submit_comment' post.id %}" class="comment-form">
                        {% csrf_token %}
                        <input type="hidden" name="parent" value="{{ comment.id }}">

                        {% if not user.is_authenticated %}
                        <div class="form-group">
                            <label for="reply-author-name-{{ comment.id }}">Name *</label>
                            <input type="text" name="author_name" id="reply-author-name-{{ comment.id }}"
                                class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="reply-author-email-{{ comment.id }}">Email</label>
                            <input type="email" name="author_email" id="reply-author-email-{{ comment.id }}"
                                class="form-control">
                        </div>
                        {% else %}
                        <!-- Hidden fields for logged-in users -->
                        <input type="hidden" name="author_name" value="{{ user.username }}">
                        <input type="hidden" name="author_email" value="{{ user.email }}">
                        <div class="form-group">
                            <label>Replying as: <strong>{{ user.username }}</strong></label>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="reply-content-{{ comment.id }}">Reply *</label>
                            <textarea name="content" id="reply-content-{{ comment.id }}" class="form-control" rows="3"
                                required></textarea>
                        </div>

                        <div class="reply-form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Submit Reply</button>
                            <button type="button" class="btn btn-outline btn-sm cancel-reply"
                                data-comment-id="{{ comment.id }}" data-action="cancel-reply">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Display Replies -->
                {% if comment.replies_list %}
                <div class="comment-replies" data-replies-container>
                    {% for reply in comment.replies_list %}
                    <article class="comment reply" id="comment-{{ reply.id }}" data-comment-id="{{ reply.id }}">
                        <header class="comment-header">
                            <span class="comment-author">{{ reply.get_display_name }}</span>
                            <time class="comment-date" datetime="{{ reply.created_at|date:'c' }}">
                                {{ reply.created_at|date:"M j, Y \a\t g:i A" }}
                            </time>
                        </header>

                        <div class="comment-content">
                            {{ reply.content|linebreaks }}
                        </div>

                        <!-- Moderation Actions for Replies -->
                        {% if user.is_staff or user == post.author %}
                        <footer class="comment-actions">
                            <div class="moderation-actions">
                                <a href="{% url 'blog:moderate_comment' reply.id 'approve' %}"
                                    class="btn btn-sm btn-success" data-action="approve">Approve</a>
                                <a href="{% url 'blog:moderate_comment' reply.id 'reject' %}"
                                    class="btn btn-sm btn-warning" data-action="reject">Reject</a>
                                <a href="{% url 'blog:moderate_comment' reply.id 'spam' %}"
                                    class="btn btn-sm btn-danger" data-action="spam">Spam</a>
                            </div>
                        </footer>
                        {% endif %}
                    </article>
                    {% endfor %}
                </div>
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-comments">
            <p>No comments yet. Be the first to comment!</p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block sidebar %}
<div class="blog-sidebar">
    <div class="sidebar-widget">
        <h3>Subscribe</h3>
        <p>Get notified when new posts are published!</p>
        <a href="{% url 'blog:rss_feed' %}" class="btn btn-outline btn-block">
            <i class="fas fa-rss"></i> RSS Feed
        </a>
    </div>

    {% if user.is_authenticated %}
    <div class="sidebar-widget">
        <h3>Quick Actions</h3>
        <a href="{% url 'blog:post_create' %}" class="btn btn-primary btn-block">New Post</a>
        <a href="{% url 'blog:dashboard' %}" class="btn btn-secondary btn-block">My Dashboard</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/blog-comments.js' %}"></script>

{% if post.is_poll %}
<script>
    function votePoll(postId, voteValue) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        fetch("{% url 'blog:submit_vote' post_id=post.id vote_value=0 %}".replace('0', voteValue), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update vote counts
                    document.getElementById(`thumbs-up-count-${postId}`).textContent = data.thumbs_up;
                    document.getElementById(`thumbs-down-count-${postId}`).textContent = data.thumbs_down;
                    document.getElementById(`no-vote-count-${postId}`).textContent = data.no_vote;

                    // Update user vote display
                    const userVoteEl = document.getElementById(`user-vote-${postId}`);
                    if (userVoteEl) {
                        let voteText = '';
                        if (data.user_vote === 1) voteText = 'üëç Thumbs Up';
                        else if (data.user_vote === -1) voteText = 'üëé Thumbs Down';
                        else voteText = '‚ûñ No Vote';
                        userVoteEl.textContent = 'You voted: ' + voteText;
                    }

                    // Visual feedback
                    const buttons = document.querySelectorAll(`#poll-widget-${postId} .vote-btn`);
                    buttons.forEach(btn => btn.classList.remove('active'));
                    buttons.forEach(btn => {
                        if (parseInt(btn.dataset.vote) === data.user_vote) {
                            btn.classList.add('active');
                        }
                    });
                } else {
                    alert('Error: ' + (data.error || 'Failed to vote'));
                }
            })
            .catch(error => {
                console.error('Error voting:', error);
                alert('Error voting: ' + error);
            });
    }

    // Update time remaining countdown
    {% if post.poll_expires_at %}
    function updateTimeRemaining(postId) {
        const expiryDate = new Date('{{ post.poll_expires_at|date:"c" }}');
        const now = new Date();
        const diff = expiryDate - now;

        if (diff <= 0) {
            document.getElementById(`time-remaining-${postId}`).textContent = 'Poll has expired';
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        let timeStr = '';
        if (days > 0) timeStr += days + 'd ';
        if (hours > 0) timeStr += hours + 'h ';
        if (minutes > 0) timeStr += minutes + 'm';

        document.getElementById(`time-remaining-{{ post.id }}`).textContent = 'Time remaining: ' + timeStr;
    }

    setInterval(() => updateTimeRemaining({{ post.id }}), 60000); // Update every minute
    updateTimeRemaining({{ post.id }}); // Initial call
    {% endif %}
</script>
{% endif %}
{% endblock %}