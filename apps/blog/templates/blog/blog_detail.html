{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Snowsune Blog{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog.css' %}">
{% endblock %}

{% block content %}
<div class="blog-post-container">
    <article class="blog-post">
        <!-- Post Header -->
        <header class="post-header">
            <div class="post-meta">
                <span class="post-date">{{ post.display_date|date:"F j, Y" }}</span>
                <span class="post-author">by {{ post.author.username }}</span>
                {% if post.status == 'draft' %}
                <span class="post-status draft">Draft</span>
                {% endif %}
            </div>

            <h1 class="post-title">{{ post.title }}</h1>

            {% if post.meta_description %}
            <p class="post-description">{{ post.meta_description }}</p>
            {% endif %}

            {% if post.tags.all %}
            <div class="post-tags">
                {% for tag in post.tags.all %}
                <a href="{% url 'blog:blog_list' %}?tag={{ tag.slug }}" class="tag">{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <!-- Featured Image -->
        {% if post.featured_image %}
        <div class="post-featured-image">
            <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
        </div>
        {% endif %}

        <!-- Post Content -->
        <div class="post-content markdown-content">
            {{ post.content_html|safe }}
        </div>

        <!-- Post Footer -->
        <footer class="post-footer">
            <div class="post-actions">
                {% if user == post.author or user.is_staff %}
                <a href="{% url 'blog:post_edit' post.slug %}" class="btn btn-secondary">Edit Post</a>
                <a href="{% url 'blog:post_delete' post.slug %}" class="btn btn-danger"
                    onclick="return confirm('Are you sure you want to delete this post?')">Delete Post</a>
                {% endif %}

                <a href="{% url 'blog:blog_list' %}" class="btn btn-outline">Back to Blog</a>
            </div>

            <div class="post-info">
                <p><strong>Created:</strong> {{ post.created_at|date:"F j, Y \a\t g:i A" }}</p>
                {% if post.updated_at != post.created_at %}
                <p><strong>Last updated:</strong> {{ post.updated_at|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
                {% if post.published_at %}
                <p><strong>Published:</strong> {{ post.published_at|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
                {% if post.original_posting_date %}
                <p><strong>Originally posted:</strong> {{ post.original_posting_date|date:"F j, Y \a\t g:i A" }}</p>
                {% endif %}
            </div>
        </footer>
    </article>

    <!-- Related Posts -->
    {% if related_posts %}
    <section class="related-posts">
        <h3>Related Posts</h3>
        <div class="related-posts-grid">
            {% for related_post in related_posts %}
            <article class="related-post-card">
                {% if related_post.featured_image %}
                <div class="related-post-image">
                    <img src="{{ related_post.featured_image.url }}" alt="{{ related_post.title }}">
                </div>
                {% endif %}

                <div class="related-post-content">
                    <h4><a href="{{ related_post.get_absolute_url }}">{{ related_post.title }}</a></h4>
                    <p class="related-post-excerpt">{{ related_post.excerpt|truncatewords:20 }}</p>
                    <small>{{ related_post.display_date|date:"M j, Y" }}</small>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Comments Section -->
    <section class="comments-section">
        <h3>Comments</h3>

        <!-- Comment Form -->
        <div class="comment-form-container">
            <h4>Leave a Comment</h4>
            <form method="post" action="{% url 'blog:submit_comment' post.id %}" class="comment-form" data-comment-form>
                {% csrf_token %}
                
                {% if not user.is_authenticated %}
                <div class="form-group">
                    <label for="{{ comment_form.author_name.id_for_label }}">Name *</label>
                    {{ comment_form.author_name }}
                    {% if comment_form.author_name.errors %}
                    <div class="error-message">{{ comment_form.author_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ comment_form.author_email.id_for_label }}">Email</label>
                    {{ comment_form.author_email }}
                    {% if comment_form.author_email.errors %}
                    <div class="error-message">{{ comment_form.author_email.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ comment_form.author_website.id_for_label }}">Website</label>
                    {{ comment_form.author_website }}
                    {% if comment_form.author_website.errors %}
                    <div class="error-message">{{ comment_form.author_website.errors.0 }}</div>
                    {% endif %}
                </div>
                {% else %}
                <!-- Hidden fields for logged-in users -->
                {{ comment_form.author_name }}
                {{ comment_form.author_email }}
                {{ comment_form.author_website }}
                <div class="form-group">
                    <label>Commenting as: <strong>{{ user.username }}</strong></label>
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="{{ comment_form.content.id_for_label }}">Comment *</label>
                    {{ comment_form.content }}
                    {% if comment_form.content.errors %}
                    <div class="error-message">{{ comment_form.content.errors.0 }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary">Submit Comment</button>
            </form>
            
            {% if not user.is_authenticated %}
            <div class="comment-form-info">
                <small>ðŸ’¡ Your details will be saved in your browser and shared across the site for future use. Comments from anonymous users require moderation.</small>
            </div>
            {% else %}
            <div class="comment-form-info">
                <small>âœ… Your comment will be posted immediately since you're logged in.</small>
            </div>
            {% endif %}
        </div>

        <!-- Display Comments -->
        {% if comments %}
        <div class="comments-list" data-comments-container>
            {% for comment in comments %}
            <article class="comment" id="comment-{{ comment.id }}" data-comment-id="{{ comment.id }}">
                <header class="comment-header">
                    <span class="comment-author">{{ comment.get_display_name }}</span>
                    <time class="comment-date" datetime="{{ comment.created_at|date:'c' }}">
                        {{ comment.created_at|date:"M j, Y \a\t g:i A" }}
                    </time>
                </header>
                
                <div class="comment-content">
                    {{ comment.content|linebreaks }}
                </div>
                
                <footer class="comment-actions">
                    <button class="btn btn-sm btn-outline reply-btn" 
                            data-comment-id="{{ comment.id }}" 
                            data-action="reply">
                        Reply
                    </button>
                    
                    <!-- Moderation Actions (for staff/author) -->
                    {% if user.is_staff or user == post.author %}
                    <div class="moderation-actions">
                        <a href="{% url 'blog:moderate_comment' comment.id 'approve' %}" 
                           class="btn btn-sm btn-success" 
                           data-action="approve">Approve</a>
                        <a href="{% url 'blog:moderate_comment' comment.id 'reject' %}" 
                           class="btn btn-sm btn-warning" 
                           data-action="reject">Reject</a>
                        <a href="{% url 'blog:moderate_comment' comment.id 'spam' %}" 
                           class="btn btn-sm btn-danger" 
                           data-action="spam">Spam</a>
                    </div>
                    {% endif %}
                </footer>

                <!-- Reply Form (hidden by default) -->
                <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;" data-reply-form>
                    <form method="post" action="{% url 'blog:submit_comment' post.id %}" class="comment-form">
                        {% csrf_token %}
                        <input type="hidden" name="parent" value="{{ comment.id }}">
                        
                        {% if not user.is_authenticated %}
                        <div class="form-group">
                            <label for="reply-author-name-{{ comment.id }}">Name *</label>
                            <input type="text" name="author_name" id="reply-author-name-{{ comment.id }}" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="reply-author-email-{{ comment.id }}">Email</label>
                            <input type="email" name="author_email" id="reply-author-email-{{ comment.id }}" class="form-control">
                        </div>
                        {% else %}
                        <!-- Hidden fields for logged-in users -->
                        <input type="hidden" name="author_name" value="{{ user.username }}">
                        <input type="hidden" name="author_email" value="{{ user.email }}">
                        <div class="form-group">
                            <label>Replying as: <strong>{{ user.username }}</strong></label>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="reply-content-{{ comment.id }}">Reply *</label>
                            <textarea name="content" id="reply-content-{{ comment.id }}" class="form-control" rows="3" required></textarea>
                        </div>

                        <div class="reply-form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Submit Reply</button>
                            <button type="button" class="btn btn-outline btn-sm cancel-reply" 
                                    data-comment-id="{{ comment.id }}" 
                                    data-action="cancel-reply">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Display Replies -->
                {% if comment.replies_list %}
                <div class="comment-replies" data-replies-container>
                    {% for reply in comment.replies_list %}
                    <article class="comment reply" id="comment-{{ reply.id }}" data-comment-id="{{ reply.id }}">
                        <header class="comment-header">
                            <span class="comment-author">{{ reply.get_display_name }}</span>
                            <time class="comment-date" datetime="{{ reply.created_at|date:'c' }}">
                                {{ reply.created_at|date:"M j, Y \a\t g:i A" }}
                            </time>
                        </header>
                        
                        <div class="comment-content">
                            {{ reply.content|linebreaks }}
                        </div>
                        
                        <!-- Moderation Actions for Replies -->
                        {% if user.is_staff or user == post.author %}
                        <footer class="comment-actions">
                            <div class="moderation-actions">
                                <a href="{% url 'blog:moderate_comment' reply.id 'approve' %}" 
                                   class="btn btn-sm btn-success" 
                                   data-action="approve">Approve</a>
                                <a href="{% url 'blog:moderate_comment' reply.id 'reject' %}" 
                                   class="btn btn-sm btn-warning" 
                                   data-action="reject">Reject</a>
                                <a href="{% url 'blog:moderate_comment' reply.id 'spam' %}" 
                                   class="btn btn-sm btn-danger" 
                                   data-action="spam">Spam</a>
                            </div>
                        </footer>
                        {% endif %}
                    </article>
                    {% endfor %}
                </div>
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-comments">
            <p>No comments yet. Be the first to comment!</p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block sidebar %}
<div class="blog-sidebar">
    <div class="sidebar-widget">
        <h3>Subscribe</h3>
        <p>Get notified when new posts are published!</p>
        <a href="{% url 'blog:rss_feed' %}" class="btn btn-outline btn-block">
            <i class="fas fa-rss"></i> RSS Feed
        </a>
    </div>

    {% if user.is_authenticated %}
    <div class="sidebar-widget">
        <h3>Quick Actions</h3>
        <a href="{% url 'blog:post_create' %}" class="btn btn-primary btn-block">New Post</a>
        <a href="{% url 'blog:dashboard' %}" class="btn btn-secondary btn-block">My Dashboard</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/blog-comments.js' %}"></script>
{% endblock %}