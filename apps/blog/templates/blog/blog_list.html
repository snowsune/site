{% extends 'base.html' %}
{% load static %}

{% block title %}Blog Posts - Snowsune{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog.css' %}">
{% endblock %}

{% block content %}
<div class="blog-container">
    <!-- <div class="blog-header">
        <h1>Blog Posts</h1>
        <p>List of all blog posts!</p>
    </div> -->

    <!-- Search and Filter Bar -->
    <div class="blog-controls">
        <form method="get" class="search-form">
            <div class="search-input-group">
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search posts..."
                    class="search-input">
                <button type="submit" class="search-btn">Search</button>
            </div>
        </form>

        <div class="tag-filter">
            <span class="filter-label">Filter by tag:</span>
            <a href="{% url 'blog:blog_list' %}" class="tag-link {% if not request.GET.tag %}active{% endif %}">All</a>
            {% for tag in tags %}
            <a href="?tag={{ tag.slug }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="tag-link {% if request.GET.tag == tag.slug %}active{% endif %}">
                {{ tag.name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Blog Posts Grid -->
    <div class="blog-posts">
        {% if posts %}
        <div class="posts-grid">
            {% for post in posts %}
            <article class="post-card">
                {% if post.featured_image %}
                <div class="post-image">
                    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}">
                </div>
                {% endif %}

                <div class="post-content">
                    <div class="post-meta">
                        <span class="post-date">{{ post.display_date|date:"M j, Y" }}</span>
                        <span class="post-author">by {{ post.author.username }}</span>
                    </div>

                    <h2 class="post-title">
                        <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                    </h2>

                    <p class="post-excerpt">{{ post.excerpt|truncatewords:30 }}</p>

                    <div class="post-tags">
                        {% for tag in post.tags.all %}
                        <span class="tag">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="page-link">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="page-link">&lsaquo; Previous</a>
            {% endif %}

            <span class="current-page">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="page-link">Next &rsaquo;</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="page-link">Last &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
        {% else %}
        <div class="no-posts">
            <h3>No posts found</h3>
            <p>{% if request.GET.search %}No posts match your search
                "{{ request.GET.search }}".{% elif request.GET.tag %}No posts found with tag
                "{{ request.GET.tag }}".{% else %}No blog posts have been published yet.{% endif %}</p>
            {% if user.is_authenticated %}
            <a href="{% url 'blog:post_create' %}" class="btn btn-primary">Write the first post!</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="blog-sidebar">
    <div class="sidebar-widget">
        <h3>Recent Posts</h3>
        <ul class="recent-posts">
            {% for post in recent_posts %}
            <li>
                <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                <small>{{ post.display_date|date:"M j" }}</small>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="sidebar-widget">
        <h3>Popular Tags</h3>
        <div class="tag-cloud">
            {% for tag in tags %}
            <a href="?tag={{ tag.slug }}" class="tag-link">{{ tag.name }}</a>
            {% endfor %}
        </div>
    </div>

    {% if user.is_authenticated %}
    <div class="sidebar-widget">
        <h3>Quick Actions</h3>
        <a href="{% url 'blog:post_create' %}" class="btn btn-primary btn-block">New Post</a>
        <a href="{% url 'blog:dashboard' %}" class="btn btn-secondary btn-block">My Dashboard</a>
    </div>
    {% endif %}
</div>
{% endblock %}