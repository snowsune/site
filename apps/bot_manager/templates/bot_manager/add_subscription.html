{% extends "base.html" %}

{% block content %}
<h1>Add New Subscription</h1>

<a href="javascript:history.back()">‚Üê Back</a>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

<form method="post">
    {% csrf_token %}

    <div class="form-group">
        <label for="service_type">Service Type:</label>
        <select name="service_type" id="service_type" required>
            <option value="">Select a service</option>
            {% for value, label in service_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="guild_id">Guild:</label>
        <select name="guild_id" id="guild_id" required>
            <option value="">Select a guild</option>
            {% for guild in shared_guilds %}
            <option value="{{ guild.id }}"
                {% if preselected_guild_id and guild.id|stringformat:"s" == preselected_guild_id|stringformat:"s" %}selected{% endif %}>
                {{ guild.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="channel_id">Channel:</label>
        <select name="channel_id" id="channel_id" required>
            <option value="">Select a channel</option>
        </select>
        <script>
            // Update channel list when guild is selected
            const guildSelect = document.getElementById('guild_id');
            const channelSelect = document.getElementById('channel_id');
            const guildChannels = {{ guild_channels_json| safe }};

            function updateChannels() {
                const guildId = guildSelect.value;
                channelSelect.innerHTML = '<option value="">Select a channel</option>';

                if (guildId && guildChannels[guildId]) {
                    guildChannels[guildId].forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.id;
                        option.textContent = '#' + channel.name;
                        channelSelect.appendChild(option);
                    });
                }
            }

            guildSelect.addEventListener('change', updateChannels);

            // If guild is pre-selected, load its channels on page load
            if (guildSelect.value) {
                updateChannels();
            }
        </script>
    </div>

    <div class="form-group">
        <label for="search_criteria">Search Criteria:</label>
        <input type="text" name="search_criteria" id="search_criteria" required maxlength="255">
    </div>

    <div class="form-group">
        <label for="filters">Filters (optional):</label>
        <textarea name="filters" id="filters" rows="3"></textarea>
    </div>

    <button type="submit">Add Subscription</button>
</form>
{% endblock %}