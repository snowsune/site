{% extends "base.html" %}
{% load static %}

{% block title %}{{ guild.name }} - Fops Bot Manager{% endblock %}

{% block og_image %}{% static 'bot_manager/images/FopsCard.png' %}{% endblock %}
{% block twitter_image %}{% static 'bot_manager/images/FopsCard.png' %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bot_manager/bot_manager.css' %}">
<style>
    .log-box {
        background: #191a24;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 16px 18px;
        margin-bottom: 28px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.18);
    }

    .log-box h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 1.25rem;
    }

    .log-entries {
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 260px;
        overflow-y: auto;
    }

    .log-entry {
        display: flex;
        gap: 14px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        align-items: flex-start;
        font-size: 0.95rem;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-time {
        font-family: var(--mono-font, 'Fira Code', 'Source Code Pro', monospace);
        color: rgba(255, 255, 255, 0.7);
        min-width: 185px;
    }

    .log-level {
        font-weight: 600;
        text-transform: uppercase;
        min-width: 80px;
    }

    .log-message {
        flex: 1;
        white-space: pre-wrap;
    }

    .log-entry.log-info .log-level {
        color: #33b5e5;
    }

    .log-entry.log-warning .log-level {
        color: #ffb74d;
    }

    .log-entry.log-error .log-level,
    .log-entry.log-critical .log-level {
        color: #ff6b6b;
    }

    .log-entry.log-debug .log-level,
    .log-entry.log-trace .log-level {
        color: #9fa6b2;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ guild.name }}</h1>

<p><a href="{% url 'bot_manager_dashboard' %}">‚Üê Back to Dashboard</a></p>

{% if recent_logs %}
<div class="log-box">
    <h2>Recent Logs</h2>
    <ul class="log-entries">
        {% for log in recent_logs %}
        <li class="log-entry log-{{ log.level_lower }}">
            <span class="log-time">
                {% if log.timestamp %}
                {{ log.timestamp|date:"Y-m-d H:i:s T" }}
                {% elif log.ts %}
                {{ log.ts }}
                {% else %}
                --
                {% endif %}
            </span>
            <span class="log-level">{{ log.level }}</span>
            <span class="log-message">{{ log.message }}</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

<h2>Guild Info</h2>
<table>
    <tr>
        <th>Guild ID</th>
        <td>{{ guild.guild_id }}</td>
    </tr>
    <tr>
        <th>Name</th>
        <td>{{ guild.name }}</td>
    </tr>
    <tr>
        <th>Joined At</th>
        <td>{{ guild.joined_at }}</td>
    </tr>
    {% if guild.settings %}
    <tr>
        <th>Settings</th>
        <td>
            <pre>{{ guild.settings }}</pre>
        </td>
    </tr>
    {% endif %}
    {% if guild.features %}
    <tr>
        <th>Features</th>
        <td>{{ guild.features }}</td>
    </tr>
    {% endif %}
</table>

<h2>Bot Configuration</h2>

{% if not guild.admin_channel_id %}
<div class="admin-channel-warning">
    ‚ö†Ô∏è You should configure an admin channel for Fops to post admin information in!
</div>
{% endif %}

<form method="post">
    {% csrf_token %}

    <!-- Admin Channel -->
    <div class="admin-channel-config">
        <label for="admin_channel_id">
            Admin Notification Channel:
            <select name="admin_channel_id" id="admin_channel_id">
                <option value="">None</option>
                {% for channel in channels %}
                <option value="{{ channel.id }}"
                    {% if guild.admin_channel_id|stringformat:"s" == channel.id|stringformat:"s" %}selected{% endif %}>
                    #{{ channel.name }}
                </option>
                {% endfor %}
            </select>
        </label>
    </div>

    <!-- Freeze Button! -->
    <div class="freeze-toggle">
        <label>
            <input type="checkbox" name="frozen" {% if guild.frozen %}checked{% endif %}>
            ! PAWS ! (Stop the bot from automatic posting) !
        </label>
    </div>

    <!-- Other Settings -->
    <div class="settings-toggles">
        <label>
            <input type="checkbox" name="allow_nsfw" {% if guild.allow_nsfw %}checked{% endif %}>
            üîû NSFW Enabled
        </label>
        <label>
            <input type="checkbox" name="enable_dlp" {% if guild.enable_dlp %}checked{% endif %}>
            üîí DLP (Download & Reposting)
        </label>
        <label>
            <input type="checkbox" name="twitter_obfuscate" {% if guild.twitter_obfuscate %}checked{% endif %}>
            üîÅ Twitter Obfuscate
        </label>
        <label for="twitter_wrapper" class="text-input">
            üê¶ Twitter Wrapper
            <input type="text" name="twitter_wrapper" id="twitter_wrapper"
                value="{{ guild.twitter_wrapper|default_if_none:'' }}" placeholder="https://proxy.example/">
        </label>
        <small class="settings-note">Lili approved feature~</small>
    </div>

    <button type="submit" name="update_settings" class="btn btn-primary">Save Settings</button>
</form>

<small>üêÅ ‚¨Ö I put this mouse here for Tyro~</small>

<h2>Guild Subscriptions</h2>
{% if subscriptions %}
<table>
    <thead>
        <tr>
            <th>Service</th>
            <th>Search Criteria</th>
            <th>Filters</th>
            <th>Channel</th>
            <th>Added By</th>
            <th>Last Ran</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for sub in subscriptions %}
        <tr>
            <td>{{ sub.service_type }}</td>
            <td>{{ sub.search_criteria }}</td>
            <td>{{ sub.filters|default:"--" }}</td>
            <td>
                {% if sub.channel_name %}
                <a target="_blank" rel="noopener noreferrer"
                    href="https://discord.com/channels/{{ guild.guild_id }}/{{ sub.channel_id }}">#{{ sub.channel_name }}</a>
                {% else %}
                {{ sub.channel_id }}
                {% endif %}
            </td>
            <td>
                {% if sub.user_info %}
                {% if sub.user_info.avatar %}
                <img src="https://cdn.discordapp.com/avatars/{{ sub.user_info.id }}/{{ sub.user_info.avatar }}.png"
                    width="24" height="24" style="border-radius: 50%; vertical-align: middle; margin-right: 4px;">
                {% endif %}
                {{ sub.user_info.username }}
                {% else %}
                {{ sub.user_id }}
                {% endif %}
            </td>
            <td>
                {% if sub.last_ran_ago %}
                {{ sub.last_ran_ago }}
                {% else %}
                Never
                {% endif %}
            </td>
            <td>
                <a href="{% url 'bot_manager_edit_subscription' sub.id %}">Edit</a> |
                <form method="post" action="{% url 'bot_manager_delete_subscription' sub.id %}"
                    style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('U sure you wanna delete this?')"
                        style="background: none; border: none; color: var(--link-default); cursor: pointer; padding: 0; text-decoration: underline;">
                        Delete
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No subscriptions for this guild.</p>
{% endif %}

<a href="{% url 'bot_manager_add_subscription_for_guild' guild_id=guild_id %}">Add New Subscription</a>
{% endblock %}

{% block extra_js %}
<script>
    // This is to scroll the thing lol~
    document.addEventListener("DOMContentLoaded", () => {
        const logBox = document.querySelector(".log-entries");
        if (logBox) {
            logBox.scrollTop = logBox.scrollHeight;
        }
    });
</script>
{% endblock %}