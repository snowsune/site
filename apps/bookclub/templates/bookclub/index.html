{% extends 'base.html' %}
{% load static %}
{% load bookclub_tags %}

{% block title %}Comic Book Club - Snowsune{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bookclub/css/bookclub.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'bookclub/js/bookclub.js' %}"></script>
{% endblock %}

{% block content %}
{% if comic %}
<div class="comic-info">
    {% if comic.preview_image %}
    <img src="{{ comic.preview_image.url }}" alt="Monthly Comic Preview" class="preview-image">
    {% endif %}
    <div class="blurb markdown-content">
        {{ comic.blurb_html|safe }}
    </div>
</div>
{% endif %}

<div class="leaderboard">
    <h2>Readers!</h2>
    {% if comic %}
    <div class="progress-timeline">
        <div class="timeline-bar">
            <div class="timeline-track">
                {% for item in progress_list %}
                <div class="progress-marker" style="left: {{ item.position }}%"
                    title="{{ item.progress.user.username }} - Page {{ item.progress.page_number }}">
                    {% if item.progress.user.get_profile_picture_url %}
                    <img src="{{ item.progress.user.get_profile_picture_url }}" alt="{{ item.progress.user.username }}"
                        class="marker-pfp">
                    {% else %}
                    <div class="marker-pfp placeholder"></div>
                    {% endif %}
                    <span class="marker-label">{{ item.progress.user.username }}</span>
                    <span class="marker-page">Page {{ item.progress.page_number }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="timeline-labels">
            <span class="timeline-start">{{ comic.start_page }}</span>
            <span class="timeline-end">{{ comic.end_page }}</span>
        </div>
    </div>

    {% if user.is_authenticated %}
    <div class="move-bookmark">
        <p>Move your bookmark!</p>
        <form method="post" action="">
            {% csrf_token %}
            <label for="page_number">Page Number (0-{{ comic.end_page }})</label>
            <input type="number" name="page_number" id="page_number" min="{{ comic.start_page }}"
                max="{{ comic.end_page }}"
                value="{% if user_progress %}{{ user_progress.page_number }}{% else %}{{ comic.start_page }}{% endif %}"
                placeholder="Page number">
            <label for="comment">Comment (optional)</label>
            <textarea name="comment" id="comment" rows="2" placeholder="Write whats on your mind!~"></textarea>
            <p class="spoiler-note">Use ||...|| to mark spoilers!~</p>
            <button type="submit">Update</button>
        </form>
    </div>
    {% else %}
    <p class="login-prompt">Log in to add your place to the bar!</p>
    {% endif %}

    {% if comments %}
    <div class="comments-section">
        <h3>Comments</h3>
        <div class="comments-list">
            {% for comment_data in comments %}
            <div class="comment-item">
                <div class="comment-left">
                    {% if comment_data.comment.user.get_profile_picture_url %}
                    <img src="{{ comment_data.comment.user.get_profile_picture_url }}"
                        alt="{{ comment_data.comment.user.username }}" class="comment-pfp">
                    {% else %}
                    <div class="comment-pfp placeholder"></div>
                    {% endif %}
                    <div class="comment-meta">
                        <span class="comment-username">{{ comment_data.comment.user.username }}</span>
                        {% if comment_data.page_url %}
                        <a href="{{ comment_data.page_url }}" class="comment-page-link" target="_blank"
                            rel="noopener noreferrer">
                            Page {{ comment_data.comment.page_number }}
                        </a>
                        {% else %}
                        <a href="#" class="comment-page-link" onclick="return false;" title="Page URL not configured">
                            Page {{ comment_data.comment.page_number }}
                        </a>
                        {% endif %}
                        <span class="comment-date">{{ comment_data.comment.created_at|date:"M d, Y" }}</span>
                        {% if user.is_authenticated and user == comment_data.comment.user %}
                        <form method="post" action="{% url 'bookclub:delete_comment' comment_data.comment.id %}"
                            class="delete-comment-form">
                            {% csrf_token %}
                            <button type="submit" class="delete-comment-btn"
                                onclick="return confirm('Are you sure you want to delete this comment?');"
                                title="Delete comment">Ã—</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="comment-content">
                    {{ comment_data.comment.comment|process_spoilers|linebreaks }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}