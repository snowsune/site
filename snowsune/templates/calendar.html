{% extends "base.html" %}
{% load static %}

{% block title %}Calendar - Snowsune.net{% endblock %}

{% block meta_description %}View upcoming events and calendar information{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">
{% endblock %}

{% block content %}
<div id="calendar-container">
    <div id="calendar"></div>
</div>

<div id="calendar-legend">
    <h3>Calendars</h3>
    <ul>
        {% for source in calendar_sources %}
        <li>
            <span class="legend-color" style="background-color: {{ source.color }};"></span>
            <span>{{ source.name }}</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            events: function (fetchInfo, successCallback, failureCallback) {
                // Fetch events from our API endpoint
                fetch('{% url "calendar_events_api" %}')
                    .then(response => response.json())
                    .then(data => {
                        // Transform events for FullCalendar
                        const events = data.map(event => ({
                            title: event.title,
                            start: event.start,
                            end: event.end,
                            allDay: event.allDay || false,
                            description: event.description,
                            location: event.location,
                            url: event.url,
                            backgroundColor: event.color,
                            borderColor: event.color,
                            textColor: '#ffffff',
                            extendedProps: {
                                calendar: event.calendar,
                                description: event.description,
                                location: event.location,
                            }
                        }));
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error fetching calendar events:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function (info) {
                // Show event details
                let details = '<strong>' + info.event.title + '</strong>';
                if (info.event.extendedProps.description) {
                    details += '<br>' + info.event.extendedProps.description;
                }
                if (info.event.extendedProps.location) {
                    details += '<br><em>Location: ' + info.event.extendedProps.location + '</em>';
                }
                if (info.event.url) {
                    details += '<br><a href="' + info.event.url + '" target="_blank">More info â†’</a>';
                }

                alert(details);

                // If event has a URL, you could navigate there instead:
                // if (info.event.url) {
                //     window.open(info.event.url, '_blank');
                // }
            },
            height: 'auto',
            aspectRatio: 1.8,
        });

        calendar.render();
    });
</script>
{% endblock %}